[TOC]



# 什么是临界段

临界段用一句话概括就是一段在执行的时候不能被中断的代码段。在RT-Thread里面，这个临界段最常出现的就是对全局变量的操作，全局变量就好像是一个枪把子，谁都可以对他开枪，但是我开枪的时候，你就不能开枪，否则就不知道是谁命中了靶子。那么什么情况下临界段会被打断？一个是系统调度，还有一个就是外部中断。在RT-Thread，系统调度，最终也是产生PendSV中断，在PendSVHandler里面实现线程的切换，所以还是可以归结为中断。既然这样，RT-Thread对临界段的保护就处理的很干脆了，直接把中断全部关了，NMIFAULT和硬FAULT除外。

# Cortex-M内核快速关中断指令

```assembly
CPSID I;PRIMASK=1;关中断
CPSIE I;PRIMASK=0;开中断
CPSID F;FAULTMASK=1;关异常
CPSIE F;FAULTMASK=0;开异常
```

​																			表1:Cortex-M内核中断屏蔽寄存器组描述

| 名字      | 功能描述                                                     |
| --------- | ------------------------------------------------------------ |
| PRIMASK   | 这是个只有单一比特的寄存器。在它被置1后，就关掉所有可屏蔽的异常，只剩下NMI和硬FAULT可以响应。它的缺省值是0，表示没有关中断。 |
| FAULTMASK | 这是个只有1个位的寄存器。当它置1时，只有NMI才能响应，所有其它的异常，甚至是硬FAULT，也通通闭嘴。它的缺省值也是0，表示没有关异常。 |
| BASEPRI   | 这个寄存器最多有9位（由表达优先级的位数决定）。它定义了被屏蔽优先级的阈值。当它被设成某个值后，所有优先级号大于等于此值的中断都被关（优先级号越大，优先级越低）。但若被设成0，则不关闭任何中断，0也是缺省值。 |



# 关中断

```C
rt_base_t rt_hw_interrupt_disable();
```

# 开中断

```C
void rt_hw_interrupt_enable(rt_base_t level);
```

